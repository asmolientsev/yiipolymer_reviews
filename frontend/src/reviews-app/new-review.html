<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!--
`<new-review>` injects a ability for creating new review into your page.

In typical use, just slap some `<new-review>` at your body:

    <body>
      <new-review url="`url`"></new-review>
-->

<dom-module id="new-review" attributes="url">
  <style>
    .out {
      position: fixed;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      top:0;
      left:0;
    }
    .in {
      position: fixed;
      top:20%;
      left:30%;
      width:400px;
      height:360px;
      background-color: white; 
      padding: 20px;
    }
    label {
      display: block;
    }
    input, textarea {
      width: 90%;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .p10 {
      padding: 10px 0;
    }
    .add {
      background-color: rgb(21,101,192);
      color:white;
      padding:5px 15px;
      border-radius: 5px;
      border:none;
    }
    ul.errors{
      display: none;
      font-style: italic;
      color: red;
    }
    .has-errors + ul.errors{       
      display: block;
    }
    .has-errors + input, .has-errors + textarea {
      border-color: red;
    }
    .has-success + input, .has-success + textarea {
      border-color: green;
    } 
    .close {
      float:right;
    }
    .hidden {
      display: none;
    }
  </style>
  <template>

    <iron-ajax
        id="ajax_new"
        handle-as="json"
        method={{method}}
        on-response="hresponse"
        debounce-duration="3000"
        url="{{url}}">
    </iron-ajax>
    <div>
      <button on-click="addItem" class="add">Add</button>
    </div>
    <div class="out hidden" on-click="hideDialog">
      <div class="in">
          <a href="javascript:void(0)" class="close" on-click="hideDialog">close</a>
          <h2>Add new review</h2>
          <div class="p10">* - field required</div>
          <div>
              <label for="id_username">Username:*</label>
              <input type="text" name="username" id="id_username" required>
              <ul class="errors"></ul>
          </div>
          <div>
              <label for="id_product">Product:*</label>
              <input type="text" name="product" id="id_product" required>
              <ul class="errors"></ul>
          </div>
          <div>
              <label for="id_body">Review:*</label>
              <textarea name="body" id="id_body" required></textarea>
              <ul class="errors"></ul>
          </div>
          <button on-click="setajax" class="add">Send data</button>
          <div class="errors"></div>
      </div>
    <div>
  </template>
  <script>

    function checkSimpleInput(item){
      var res = true;
      var messages = [];
      item.value = '';
      item.parentNode.classList.remove('has-errors');
      item.parentNode.classList.remove('has-success');
      var errorsList = el.parentNode.querySelector('.errors');
      errorsList.innerHTML = '';
            
      if (item.hasAttribute('required') && item.value==''){
        var text = 'Field ' + item.name + ' required';
          messages.push(text:text, field:'id_'+item.name);
          res = false;
          item.parentNode.classList.add('has-errors');
          var node = document.createElement("LI");
          node.text = text;
          errorsList.appendChild(node);
      }else{
          item.parentNode.classList.add('has-success');
      }
      return {success: res, messages:messages};
    }
    /**
       * Fired when geeting `data` from backend server. Using for add out listeners
       *
       * @event success
    */
    Polymer({
      is: "new-review",
      properties: {
        /** Url for getting data. */
        url: String,
        new_id: String,
        method: String
      },
      /**
       * method checking input data and send data to server
       *
       * @method setajax
       */
      setajax: function () {
        // document.querySelector('.errors').innerHTML = '';
        var check = this.checkInputs();
        if (check.success){
          var username = this.$.id_username.value;
          var product = this.$.id_product.value;
          var body = this.$.id_body.value;
          this.$.ajax_new.body = ["username="+username,"product="+product,"body="+body].join('&');
          this.$.ajax_new.generateRequest();
        }
      },
      /**
       * Fired when geeting `data` from backend server.
       *
       * @event hresponse
       */
      hresponse: function(request) {
        this.hideDialog();
        this.clearInputData();
        this.fire('success');
      },
      /**
       * method showing dialog for input data
       *
       * @method showdialog
       */
      showDialog: function(){
        document.querySelector('.out').classList.remove('hidden');
      },
      /**
       * method hide dialog
       *
       * @method hideDialog
       */
      hideDialog: function(e){
        if (e.target==e.currentTarget)
          document.querySelector('.out').classList.add('hidden');
      },
      /**
       * method clear input data
       *
       * @method clearInputData
       */
      clearInputData: function(){
        this.$.id_username.value = '';
        this.$.id_product.value = '';
        this.$.id_body.value = '';
      },
      /**
       * Function for checking input data
       * return {success:true} if ok, and {success:false, message:`message`} if not
       * @function checkInput
      */
      checkInputs: function(){
        var res = true;
        var messages = [];
        document.querySelectorAll('input,textarea').forEeach(function(item){
          var out = checkSimpleInput(item);
          messages + out.messages;
          res = res && out.res;
        });
        if (res) return {success:true};
        else return {success:false, messages:messages};
      },
      addItem: function(){
        this.new_id = null;
        this.method = "POST";
        this.showDialog();
      },
      deleteItem: function(){

      },
      updateItem: function(){
        
      }
    });
  </script>
</dom-module>