<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="new-review.html">
<!--
`<reviews-list>` injects a list of reviews into your page.

In typical use, just slap some `<reviews-list>` at your body:

    <body>
      <reviews-list apiroot=""></reviews-list>

Wham! It's all reviews now!
-->

<dom-module id="reviews-list" attributes="params">
  <template>
    <style>
      :host {
        display: block;
      }
      .menu {
        width:30%;
        float:left;
      }
      .view {
        margin-left: 40%;
      }
      .hidden-body {
        position: absolute;
        left:-100000px;
      }
      article {
        padding: 10px 20px;
      }
      article.active {
        background-color: #eee;
        color: black;
      }
      .pl20 {
        padding-left: 20px;
      }
      .mb10 {
        margin-bottom: 10px;
      }
    </style>
    <iron-ajax
        id="ajax_list"
        url="{{endpoint}}"
        params="{params}"
        handle-as="json"
        last-response="{{data}}"
        on-response="hresponse">
    </iron-ajax>
    <div class="pl20 mb10">
        <h1>Reviews</h1>
        <new-review url="{{endpoint}}" id="new_review"></new-review>
    </div>
    <div class="menu">
        <template is="dom-repeat" items="{{data}}" id="reviews-template">
            <article id="{{item._id}}">
               <a href="javascript:void(0)" class="checkuser" onclick="clickUser(this)">User: {{item.username}}, Product: {{item.product}} </a> 
               <span class="hidden-body body">{{item.body}}</span>
               <span class="hidden-body created">{{item.created_at}}</span>
               <br/>
            </article>
        </template>
    </div>
    <div class="view">
        
    </div>
  </template>

  <script>
    /**
       * Listener for click event of users,  show body and created data
       * 
       * @listener  `user` click
    */
    function clickUser(el){
      var activeArticle = document.querySelector('article.active');
      if (activeArticle)
        activeArticle.classList.remove('active');
      var parent = el.parentNode;
      parent.classList.add('active');
      var _text = parent.querySelector('.body').innerHTML;
      var _time = new Date(parseInt(parent.querySelector('.created').innerHTML));
      document.querySelector('.view').innerHTML = _text+', <br/>created: '+_time;
      return false;
    };

    Polymer({

      is: 'reviews-list',

      properties: {
        /** Backend Server name for getting data. */
        apiroot: String,
      },

      ready: function() {
        this.endpoint = this.apiroot + '/api/reviews';
        this.listen(this.$.new_review, 'success', 'updateReviews');
        
        this.$.ajax_list.generateRequest();
        
      },
      /**
       * method calls when need get new state of data from backend server.
       *
       * @method updateReviews
       */
      updateReviews: function() {
        return this.$.ajax_list.generateRequest();
      },
      /**
       * Fired when geeting `data` from backend server.
       *
       * @event hresponse
       */
      hresponse: function(){
        var ironAjax = this.$.ajax_list;
        if (ironAjax.lastResponse!=undefined){
            setTimeout(function(){document.querySelector('.checkuser').click();},500);
        }
      }
    });
  </script>
</dom-module>
