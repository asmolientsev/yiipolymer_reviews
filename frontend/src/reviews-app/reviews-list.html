<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="new-review.html">
<link rel="import" href="reviews-pagination.html">
<!--
`<reviews-list>` injects a list of reviews into your page.

In typical use, just slap some `<reviews-list>` at your body:

    <body>
      <reviews-list apiroot=""></reviews-list>

Wham! It's all reviews now!
-->

<dom-module id="reviews-list" attributes="params">
  <template>
    <style>
      :host {
        display: block;
      }
      .menu {
        width:35%;
        float:left;
        padding-left: 10px;
      }
      .view {
        margin-left: 40%;
      }
      .hidden-body {
        position: absolute;
        left:-100000px;
      }
      article {
        padding: 10px 20px;
      }
      article.active {
        background-color: #eee;
        color: black;
      }
      .pl20 {
        padding-left: 20px;
      }
      .pr20 {
        padding-right: 20px;
      }
      .mb10 {
        margin-bottom: 10px;
      }
      article {
        display: table-row;
      }
      article a {
        display: table-cell;
        padding: 7px 5px;
        border-bottom: 1px solid #ccc;
        text-decoration: none;
        outline: none;
        background-repeat: no-repeat;
        background-position: center;
        min-width: 30px;
      }
      h1 {
        border-bottom: 1px dotted #ccc;
        padding-bottom: 10px;
      }
      .pagination {
        position: absolute;
        bottom: 30px;
        width:100%;
      }
      .edituser {
        background-image: url(images/icon_table_edit.png);
      }
      .deleteuser {
        background-image: url(images/icon_table_del.png);
      }
    </style>
    <iron-ajax
        id="ajax_list"
        url="{{endpoint}}"
        params="{params}"
        handle-as="json"
        last-response="{{data}}"
        on-response="hresponse"
        on-error="herror">
    </iron-ajax>
    <div class="pl20 mb10 pr20">
        <h1>Reviews</h1>
        <new-review url="{{endpoint}}" title="Add new review" id="new_review"></new-review>
    </div>
    <div class="menu">
        <template is="dom-repeat" items="{{data}}" id="reviews-template">
            <article id="{{item._id}}">
               <a href="javascript:void(0)" class="checkuser" on-click="clickUser">User: {{item.username}}, Product: {{item.product}} </a>
               <span class="hidden-body username">{{item.username}}</span>
               <span class="hidden-body product">{{item.product}}</span>
               <span class="hidden-body body">{{item.body}}</span>
               <span class="hidden-body created">{{item.created_at}}</span>
               <a href="javascript:void(0)" class="edituser" on-click="editUser" alt="edit"></a>
               <a href="javascript:void(0)" class="deleteuser" on-click="deleteUser" alt="del"></a>
               <br/>
            </article>
        </template>
        
    </div>
    <div class="view">
        
    </div>
    <div class="pagination">
      <reviews-pagination url="{{endpoint}}" current_page="{{current_page}}" page_count="{{page_count}}" id="reviews_pagination"></reviews-pagination>
    </div>
  </template>

  <script>
    Polymer({

      is: 'reviews-list',

      properties: {
        /** Backend Server name for getting data. */
        apiroot: String,
        current_page: {
          type: Number,
          value: 0
        },
        page_count:  {
          type: Number,
          value: 0
        },
        show_errors: {
          type: Number,
          value: 1
        },
      },

      ready: function() {
        this.endpoint = this.apiroot + '/api/reviews?per-page=5';
        
        this.listen(this.$.new_review, 'success', 'updateReviews');
        this.listen(this.$.reviews_pagination, 'clicklink', 'updatePage');
        
        this.$.ajax_list.generateRequest();
      },
      /**
       * method calls when need get new state of data from backend server.
       *
       * @method updateReviews
       */
      updateReviews: function() {
        return this.$.ajax_list.generateRequest();
      },
      /**
       * Fired when geeting `data` from backend server.
       *
       * @event hresponse
       */
      hresponse: function(e, request){
        var ironAjax = this.$.ajax_list;
        var self = this;
        if (ironAjax.lastResponse!=undefined){
            this.show_errors = 0;
            setTimeout(function(){self.$$('.checkuser').click();},500);
            var headers = request.xhr.getAllResponseHeaders();
            this._setDataPagination(headers);
            this.$.reviews_pagination.generate();
        }
      },
      /**
       * Listener for click event of users,  show body and created data
       * 
       * @listener  `user` click
      */
      clickUser: function(e){
        var el = e.target;
        var activeArticle = this.$$('article.active');
        if (activeArticle)
          activeArticle.classList.remove('active');
        var parent = el.parentNode;
        parent.classList.add('active');
        var _text = parent.querySelector('.body').textContent;
        var _time = new Date(parseInt(parent.querySelector('.created').textContent));
        this.$$('.view').innerHTML = _text+', <br/><b>created:</b> '+_time.getDate() + "." + (_time.getMonth() + 1) + "." + _time.getFullYear();
        return false;
      },
      /**
       * Listener for click event of users,  show body and edit user data
       * 
       * @listener  `edituser` click
      */
      editUser: function(e){
        var parent = e.target.parentNode;
        this.$.new_review.new_id = parent.id;
        this.$.new_review.title = 'Edit review';
        obj = {
          username: parent.querySelector('.username').textContent, 
          product: parent.querySelector('.product').textContent,
          body: parent.querySelector('.body').textContent
        };
        this.$.new_review.updateItem(obj);
        return false;
      },
      /**
       * Listener for click event of users,  delete selected user
       * 
       * @listener  `deleteuser` click
      */
      deleteUser: function(e){
        if (confirm('Are you sure that you want delete item?')){
          var parent = e.target.parentNode;
          this.$.new_review.new_id = parent.id;
          this.$.new_review.deleteItem();
        }  
        return false;
      },
      /**
       * method calls when need add pagination.
       *
       * @method _setDataPagination
       */
      _setDataPagination: function(headers){
        var self = this;
        headers.split('\n').forEach(function(item){
          var ars = item.split(':');
          if (ars[0]=='X-Pagination-Page-Count')
            self.page_count = parseInt(ars[1]);
          else if (ars[0]=='X-Pagination-Current-Page')
            self.current_page = parseInt(ars[1]);
        });
      },
      /**
       * method calls when need update data on page after clicks in pagination.
       *
       * @method updatePage
       */
      updatePage: function(){
        var endpoint = this.endpoint;
        this.endpoint = this.$.reviews_pagination.$.url;
        this.updateReviews();
        this.endpoint = endpoint;
      },
      herror: function(e, request){
        if (this.show_errors)
          alert('Error: ' + (request.request.xhr.status ? request.request.xhr.statusText : 'request is not complete'));
      }
    });
  </script>
</dom-module>
